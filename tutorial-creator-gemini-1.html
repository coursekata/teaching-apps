<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Interactive Tutorial Creator - v13.49 (Stable)</title>
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] },
    startup: { ready: () => MathJax.startup.defaultReady() }
  };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
<style>
  /* --- ORIGINAL UI STYLES (Preserved) --- */
  :root{ --accent:#2563eb; --record:#ef4444; --success:#10b981; --warning:#f59e0b; --teal:#06b6d4; }
  body{ margin:0; font:14px/1.4 system-ui,-apple-system,sans-serif; color:#111; background:#f5f5f5; }
  
  .tutorial-header{ position: sticky; top: 0; background:#fff; border-bottom:2px solid #ddd; padding:12px 20px; box-shadow:0 2px 4px rgba(0,0,0,0.05); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
  .version-number{ color: #666; font-size: 12px; font-weight: 500; }
  .tutorial-controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  
  /* Buttons - Fixed Active States */
  button{ padding:8px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px; transition: background 0.1s; }
  button:hover:not(:disabled):not(.primary):not(.record):not(.success):not(.warning):not(.teal){ background:#f9f9f9; }
  button:disabled{ opacity:0.5; cursor:not-allowed; }
  
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button.primary:active { background: #1d4ed8; }
  
  button.record{ background:var(--record); color:#fff; border-color:var(--record); }
  button.record:active { background: #b91c1c; }
  
  button.success{ background:var(--success); color:#fff; border-color:var(--success); }
  button.warning{ background:var(--warning); color:#fff; border-color:var(--warning); }
  button.teal{ background:var(--teal); color:#fff; border-color:var(--teal); }
  
  .recording-active{ animation:pulse 1.5s infinite; }
  @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:0.6} }
  
  .recording-indicator{ background:var(--record); color:#fff; padding:6px 12px; border-radius:20px; font-weight:600; font-size:13px; animation:pulse 1.5s infinite; }
  .paused-indicator{ background:var(--warning); color:#fff; padding:6px 12px; border-radius:20px; font-weight:600; font-size:13px; }
  
  /* App Container */
  .app-container{ position:relative; width:1000px; height:800px; overflow:hidden; margin:0 auto 40px auto; border:1px solid #ddd; border-radius:8px; background: white; }
  iframe{ width:1000px; height:100%; border:none; }
  iframe.playback-mode{ pointer-events:none; }
  
  /* Timeline */
  .timeline-container{ background:#fff; border-top:2px solid #ddd; border-bottom:2px solid #ddd; padding:4px 20px 6px 20px; display:none; position:relative; margin-bottom:8px; overflow-x: auto; }
  .timeline-container.visible{ display:block; }
  .timeline-wrapper { position: relative; min-width: 100%; height: 100px; }
  
  .timeline-ruler{ height:14px; position:relative; margin-left:60px; border-bottom: 1px solid #eee; }
  .timeline-tick{ position:absolute; top:0; font-size:9px; color:#999; border-left: 1px solid #eee; height: 100%; padding-left: 2px; }
  
  .timeline-track{ height:26px; background:#fafafa; border:1px solid #ddd; border-radius:4px; position:relative; margin-bottom:2px; margin-left: 60px; }
  .timeline-track-label{ position:absolute; left:0; top:50%; transform:translateY(-50%); font-size:9px; font-weight:600; color:#666; width:55px; text-align:right; padding-right:5px; pointer-events: none; margin-left: -60px; }
  
  .timeline-event{ position:absolute; top:4px; bottom:4px; width:8px; background:#6366f1; border-radius:2px; cursor:move; z-index:1; box-shadow:0 1px 3px rgba(99,102,241,0.3); }
  .timeline-event.drag-event{ width:auto; background:#8b5cf6; opacity: 0.9; }
  .timeline-event:hover{ background:#4f46e5; z-index: 2; }
  
  .timeline-annotation{ position:absolute; top:4px; bottom:4px; background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius:3px; color:#fff; font-size:10px; padding:0 6px; display:flex; align-items:center; cursor:move; white-space:nowrap; overflow:hidden; z-index:2; border:1px solid rgba(255,255,255,0.2); }
  
  .timeline-pause{ position:absolute; top:45px; width:12px; height:12px; background:#f59e0b; transform:translateY(-50%) rotate(45deg); cursor:move; z-index:10; border:1px solid rgba(255,255,255,0.3); margin-left: 60px; }
  
  .timeline-playhead{ position:absolute; top:14px; height:60px; width:2px; background:#ef4444; pointer-events:none; z-index:9999; margin-left: 60px; }
  .timeline-playhead::before{ content:''; position:absolute; top:-8px; left:50%; transform:translateX(-50%); width:12px; height:12px; background:#ef4444; border-radius:50%; border:2px solid #fff; cursor:grab; pointer-events:auto; }
  
  /* Modals */
  .modal-overlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal-overlay.visible{ display:flex; }
  .modal{ background:#fff; border-radius:12px; padding:24px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.2); }
  .modal h2{ margin:0 0 16px; }
  .info-box{ background:#e0f2fe; border:1px solid #0284c7; border-radius:8px; padding:12px; margin:12px 0; font-size:13px; color:#0c4a6e; }
  .form-group{ margin-bottom:16px; }
  .form-group label{ display:block; margin-bottom:6px; font-weight:600; color:#374151; }
  textarea, input[type=text], input[type=number]{ width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; font-family:inherit; box-sizing: border-box; }
  .modal-buttons{ display:flex; gap:8px; margin-top:16px; justify-content:flex-end; }
  .control-group{ display:flex; gap:8px; align-items:center; }
  input.url-input { width: 300px; }
</style>
</head>
<body>

<div class="tutorial-header">
  <div class="tutorial-controls">
    <div class="control-group">
      <label>App URL: <input type="text" id="appUrl" class="url-input" placeholder="e.g. confidence-demo.html" value=""/></label>
      <button id="loadApp" class="primary">Load App</button>
      <button id="startRecording" class="record" style="display:none;">‚è∫ Record</button>
      <button id="playPauseRecording" class="warning" style="display:none;">‚è∏ Pause</button>
      <button id="addAnnotation" class="teal" style="display:none;" disabled>+Text</button>
      <button id="addPause" class="warning" style="display:none;" disabled>+Pause</button>
      <button id="previewRecording" class="primary" style="display:none;" disabled>‚ñ∂ Play</button>
      <button id="exportRecording" class="success" style="display:none;" disabled>Export</button>
      <button id="tutorialStyles" class="teal" style="display:none;" disabled>Styles</button>
      <button id="loadJSON" class="success" style="display:none;">Import</button>
      <span id="recordingIndicator" class="recording-indicator" style="display:none;">‚è∫ REC</span>
      <span id="pausedIndicator" class="paused-indicator" style="display:none;">‚è∏ PAUSED</span>
    </div>
    <input type="file" id="jsonFileInput" accept=".json" style="display:none;">
  </div>
  <div class="version-number">v13.49 (Refactored)</div>
</div>

<div id="timelineContainer" class="timeline-container">
  <div class="timeline-wrapper" id="timelineWrapper">
    <div id="timelineRuler" class="timeline-ruler"></div>
    <div class="timeline-track">
      <div class="timeline-track-label">Events</div>
      <div id="eventsTrack"></div>
    </div>
    <div class="timeline-track">
      <div class="timeline-track-label">Notes</div>
      <div id="annotationsTrack"></div>
    </div>
    <div id="timelinePlayhead" class="timeline-playhead" style="display:none; left: 60px;"></div>
  </div>
</div>

<div class="app-container">
  <iframe id="appFrame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<div id="annotationEditorModal" class="modal-overlay">
  <div class="modal">
    <h2>Add Annotation</h2>
    <div class="info-box">Enter content using HTML. Use CSS classes defined in Styles.</div>
    <div class="form-group"><label>Content</label><textarea id="annContent" rows="3"></textarea></div>
    <div class="form-group"><label>Custom CSS</label><textarea id="annCSS" rows="2"></textarea></div>
    <div class="form-group"><label>Duration (s)</label><input type="number" id="annDuration" value="5"></div>
    <div class="modal-buttons"><button id="cancelAnnotation">Cancel</button><button id="createAnnotation" class="primary">Position & Save</button></div>
  </div>
</div>

<div id="positionEditorOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:99;pointer-events:none;">
  <div style="position:absolute;top:20px;left:50%;transform:translateX(-50%);background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);pointer-events:auto;">
    <div style="font-weight:bold;margin-bottom:8px">üìç Position Annotation</div>
    <div style="display:flex;gap:8px"><button id="savePosition" class="success">Save</button><button id="deletePosition" class="record">Delete</button></div>
  </div>
</div>

<div id="tutorialStylesModal" class="modal-overlay">
  <div class="modal">
    <h2>Global Styles</h2>
    <textarea id="tutorialStylesCSS" style="width:100%;height:300px;font-family:monospace;"></textarea>
    <div class="modal-buttons"><button id="cancelTutorialStyles">Cancel</button><button id="saveTutorialStyles" class="primary">Save</button></div>
  </div>
</div>

<div id="exportModal" class="modal-overlay">
  <div class="modal">
    <h2>Export JSON</h2>
    <textarea id="exportTextarea" style="width:100%;height:300px;" readonly></textarea>
    <div class="modal-buttons"><button id="closeExportModal">Close</button></div>
  </div>
</div>

<script>
(function() {
  // --- UTILS ---
  const $ = id => document.getElementById(id);
  const show = (el, d='inline-block') => el.style.display = d;
  const hide = el => el.style.display = 'none';
  const enable = el => el.disabled = false;
  const disable = el => el.disabled = true;

  // --- STATE ---
  const State = {
    api: null,
    model: {
      initialState: null, snapshots: [], annotations: [], pauses: [],
      globalStyles: ".simple-box { background: white; border: 2px solid blue; padding: 10px; border-radius: 5px; }",
      duration: 0
    },
    mode: 'idle', // idle, recording, paused, playing
    timing: { start: 0, pausedTotal: 0, pauseStart: 0, playStart: 0, pausedPlayAt: 0 },
    tempAnn: null
  };

  // --- CORE LOGIC ---
  
  const App = {
    init() {
      // 1. Load
      $('loadApp').onclick = () => {
        const url = $('appUrl').value || 'confidence-demo-new-13.html';
        const iframe = $('appFrame');
        
        disable($('loadApp'));
        $('loadApp').textContent = 'Loading...';
        iframe.src = url;
        
        let checks = 0;
        const poll = setInterval(() => {
          if (iframe.contentWindow && iframe.contentWindow.tutorialAPI) {
            clearInterval(poll);
            State.api = iframe.contentWindow.tutorialAPI;
            this.onAppReady();
          } else if (checks++ > 50) {
            clearInterval(poll);
            alert("Error: 'tutorialAPI' not found in the app. Please use the Refactored Confidence Demo provided.");
            enable($('loadApp'));
            $('loadApp').textContent = 'Load App';
          }
        }, 200);
      };

      // 2. Record / Pause / Resume
      $('startRecording').onclick = () => this.toggleRecord();
      $('playPauseRecording').onclick = () => this.togglePause();
      
      // 3. Tools
      $('addAnnotation').onclick = () => { 
        $('annotationEditorModal').classList.add('visible'); 
        $('annContent').value='<div class="simple-box">Note</div>'; 
      };
      $('createAnnotation').onclick = () => this.startAnnPositioning();
      $('savePosition').onclick = () => this.finalizeAnn();
      $('deletePosition').onclick = () => { 
        hide($('positionEditorOverlay')); 
        this.bridge.hideBox(); 
      };
      $('addPause').onclick = () => {
        State.model.pauses.push({ timestamp: this.getCurrentTime() });
        this.renderTimeline();
      };
      
      // 4. Preview
      $('previewRecording').onclick = () => this.togglePreview();
      
      // 5. Export/Styles
      $('exportRecording').onclick = () => {
        $('exportTextarea').value = JSON.stringify(State.model, null, 2);
        $('exportModal').classList.add('visible');
      };
      $('tutorialStyles').onclick = () => {
        $('tutorialStylesCSS').value = State.model.globalStyles;
        $('tutorialStylesModal').classList.add('visible');
      };
      $('saveTutorialStyles').onclick = () => {
        State.model.globalStyles = $('tutorialStylesCSS').value;
        this.bridge.injectStyles(State.model.globalStyles);
        $('tutorialStylesModal').classList.remove('visible');
      };
      
      // Modals
      $('cancelAnnotation').onclick = () => $('annotationEditorModal').classList.remove('visible');
      $('cancelTutorialStyles').onclick = () => $('tutorialStylesModal').classList.remove('visible');
      $('closeExportModal').onclick = () => $('exportModal').classList.remove('visible');
      
      // Import
      $('loadJSON').onclick = () => $('jsonFileInput').click();
      $('jsonFileInput').onchange = (e) => this.importJSON(e);
    },

    onAppReady() {
      hide($('loadApp'));
      show($('startRecording'));
      show($('loadJSON'));
      $('timelineContainer').classList.add('visible');
      this.bridge.injectBox();
      // Initialize default styles
      this.bridge.injectStyles(State.model.globalStyles);
    },

    toggleRecord() {
      if (State.mode === 'idle') {
        // Start Recording
        State.model.snapshots = []; State.model.annotations = []; State.model.pauses = [];
        State.model.initialState = State.api.getState();
        State.mode = 'recording';
        State.timing.start = Date.now();
        State.timing.pausedTotal = 0;
        
        $('startRecording').textContent = '‚è∏ Pause';
        $('startRecording').className = 'record recording-active';
        show($('recordingIndicator'));
        
        // Bind Listener
        State.api.onAction((e) => {
          if (State.mode !== 'recording') return;
          // Small delay for async operations
          setTimeout(() => {
            if (State.mode !== 'recording') return;
            const ts = Date.now() - State.timing.start - State.timing.pausedTotal;
            State.model.snapshots.push({ timestamp: ts, event: e, state: State.api.getState() });
            State.model.duration = Math.max(State.model.duration, ts);
            // Throttle timeline update
            if (!this._lastRender || Date.now() - this._lastRender > 500) {
              this.renderTimeline();
              this._lastRender = Date.now();
            }
          }, e.action === 'simulate' ? 50 : 0);
        });
        
        hide($('loadJSON'));
      } else if (State.mode === 'recording') {
        // Pause
        this.pauseRecording();
      } else if (State.mode === 'paused') {
        // Resume (via main button if confusing, but usually handled by playPauseRecording)
        this.resumeRecording();
      }
    },

    pauseRecording() {
      State.mode = 'paused';
      State.timing.pauseStart = Date.now();
      
      $('startRecording').textContent = '‚è∫ Record'; // Indicates "Resume" or "Stop" context
      $('startRecording').className = 'record'; // No pulse
      
      hide($('recordingIndicator'));
      show($('pausedIndicator'));
      
      show($('playPauseRecording')); // Show secondary resume button
      $('playPauseRecording').textContent = '‚è∫ Resume';
      
      // Enable Tools
      ['addAnnotation','addPause','previewRecording','exportRecording','tutorialStyles'].forEach(id => {
        show($(id)); enable($(id));
      });
      
      this.renderTimeline();
    },

    togglePause() {
      if (State.mode === 'paused') this.resumeRecording();
      else this.pauseRecording();
    },

    resumeRecording() {
      State.mode = 'recording';
      State.timing.pausedTotal += (Date.now() - State.timing.pauseStart);
      
      $('startRecording').textContent = '‚è∏ Pause';
      $('startRecording').className = 'record recording-active';
      $('playPauseRecording').textContent = '‚è∏ Pause';
      
      show($('recordingIndicator'));
      hide($('pausedIndicator'));
      
      // Disable Tools
      ['addAnnotation','addPause','previewRecording','exportRecording','tutorialStyles'].forEach(id => disable($(id)));
    },

    togglePreview() {
      if (State.mode === 'playing') {
        // Stop
        State.mode = 'paused';
        cancelAnimationFrame(this._raf);
        $('appFrame').classList.remove('playback-mode');
        $('previewRecording').textContent = '‚ñ∂ Play';
        $('previewRecording').classList.remove('playing');
        this.bridge.hideBox();
        // Restore state
        if (State.model.snapshots.length) {
          State.api.setState(State.model.snapshots[State.model.snapshots.length-1].state);
        }
      } else {
        // Play
        State.mode = 'playing';
        $('appFrame').classList.add('playback-mode');
        $('previewRecording').textContent = '‚èπ Stop';
        $('previewRecording').classList.add('playing');
        
        State.api.setState(State.model.initialState);
        const startPlay = Date.now();
        
        const loop = () => {
          if (State.mode !== 'playing') return;
          const now = Date.now() - startPlay;
          
          if (now > State.model.duration) {
            this.togglePreview(); // Stop
            return;
          }
          
          // Snapshots
          State.model.snapshots.forEach(s => {
            if (s.timestamp <= now && s.timestamp > now - 20) State.api.setState(s.state);
          });
          
          // Annotations
          const ann = State.model.annotations.find(a => now >= a.timestamp && now < a.timestamp + a.duration);
          if (ann) this.bridge.renderBox(ann, false);
          else this.bridge.hideBox();
          
          // Playhead
          this.renderPlayhead(now);
          
          this._raf = requestAnimationFrame(loop);
        };
        loop();
      }
    },

    // --- ANNOTATION FLOW ---
    startAnnPositioning() {
      $('annotationEditorModal').classList.remove('visible');
      State.tempAnn = {
        content: $('annContent').value,
        customCSS: $('annCSS').value,
        duration: parseInt($('annDuration').value) * 1000
      };
      this.bridge.renderBox(State.tempAnn, true); // Interactive
      show($('positionEditorOverlay'));
    },

    finalizeAnn() {
      const metrics = this.bridge.getMetrics();
      State.model.annotations.push({
        ...State.tempAnn,
        timestamp: this.getCurrentTime(),
        position: metrics
      });
      State.model.duration = Math.max(State.model.duration, this.getCurrentTime() + State.tempAnn.duration);
      
      hide($('positionEditorOverlay'));
      this.bridge.hideBox();
      this.renderTimeline();
    },

    getCurrentTime() {
      // If recording, it's "now" relative to start. If paused, it's the end.
      // Simplified: Always append to end for this version.
      return State.model.duration;
    },

    // --- BRIDGE (Iframe Manipulation) ---
    bridge: {
      injectBox() {
        const doc = $('appFrame').contentDocument;
        if (!doc.getElementById('t-box')) {
          const d = doc.createElement('div');
          d.id = 't-box';
          d.style.cssText = 'position:absolute;display:none;z-index:9999;transform-origin:top left;';
          doc.body.appendChild(d);
          
          const s = doc.createElement('style');
          s.textContent = `.t-handle{position:absolute;bottom:0;right:0;width:16px;height:16px;background:rgba(37,99,235,0.3);cursor:nwse-resize}`;
          doc.head.appendChild(s);
        }
      },
      injectStyles(css) {
        const doc = $('appFrame').contentDocument;
        let el = doc.getElementById('t-styles');
        if(!el) { el=doc.createElement('style'); el.id='t-styles'; doc.head.appendChild(el); }
        el.textContent = css;
      },
      renderBox(ann, interactive) {
        const box = $('appFrame').contentDocument.getElementById('t-box');
        if(!box) return;
        
        const p = ann.position || {left:300, top:200, width:300, height:'auto'};
        box.style.display = 'block';
        box.style.left = p.left + 'px'; box.style.top = p.top + 'px';
        box.style.width = p.width + 'px'; box.style.height = p.height === 'auto' ? 'auto' : p.height + 'px';
        
        if(ann.content.includes('class=')) {
          box.style.background = 'transparent'; box.style.border='none';
        } else {
          box.style.background = 'rgba(255,255,255,0.95)'; box.style.border = '3px solid #2563eb';
          box.style.padding='15px'; box.style.borderRadius='8px';
          if(ann.customCSS) box.style.cssText += ';' + ann.customCSS;
        }
        
        box.innerHTML = ann.content + (interactive ? '<div class="t-handle"></div>' : '');
        
        if(interactive) this.attachDrag(box);
        
        if(window.MathJax) window.MathJax.typesetPromise([box]).catch(()=>{});
      },
      hideBox() {
        const box = $('appFrame').contentDocument.getElementById('t-box');
        if(box) box.style.display = 'none';
      },
      getMetrics() {
        const box = $('appFrame').contentDocument.getElementById('t-box');
        return { left:box.offsetLeft, top:box.offsetTop, width:box.offsetWidth, height:box.offsetHeight };
      },
      attachDrag(box) {
        const doc = $('appFrame').contentDocument;
        let startX, startY, startL, startT, startW, startH, resizing=false;
        box.onmousedown = e => {
          if(e.target.className==='t-handle') resizing=true;
          startX=e.clientX; startY=e.clientY;
          startL=box.offsetLeft; startT=box.offsetTop;
          startW=box.offsetWidth; startH=box.offsetHeight;
          doc.addEventListener('mousemove', onMove);
          doc.addEventListener('mouseup', onUp);
          e.preventDefault();
        };
        const onMove = e => {
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          if(resizing) {
            box.style.width = Math.max(50, startW+dx)+'px';
            box.style.height = Math.max(20, startH+dy)+'px';
          } else {
            box.style.left = (startL+dx)+'px';
            box.style.top = (startT+dy)+'px';
          }
        };
        const onUp = () => {
          doc.removeEventListener('mousemove', onMove);
          doc.removeEventListener('mouseup', onUp);
          resizing=false;
        };
      }
    },

    // --- TIMELINE RENDERER ---
    renderTimeline() {
      const track = $('eventsTrack');
      const notes = $('annotationsTrack');
      const ruler = $('timelineRuler');
      const wrapper = $('timelineWrapper');
      const container = $('timelineContainer');
      
      track.innerHTML = ''; notes.innerHTML = ''; ruler.innerHTML = '';
      wrapper.querySelectorAll('.timeline-pause').forEach(e=>e.remove());
      
      const scale = 50; // px per sec
      const duration = Math.max(State.model.duration / 1000, 10);
      const width = duration * scale + 100;
      wrapper.style.width = width + 'px';
      
      // Ruler
      for(let i=0; i<=duration; i+=(duration>60?5:1)) {
        const tick = document.createElement('div');
        tick.className = 'timeline-tick';
        tick.style.left = (i*scale) + 'px';
        tick.textContent = i+'s';
        ruler.appendChild(tick);
      }
      
      // Events (With Grouping)
      let i = 0;
      while (i < State.model.snapshots.length) {
        const start = State.model.snapshots[i];
        const action = start.event.action;
        
        if (action.endsWith('Start')) {
          const base = action.replace('Start', '');
          let endIdx = i;
          for (let j = i+1; j < State.model.snapshots.length; j++) {
            if (State.model.snapshots[j].event.action === base + 'End') {
              endIdx = j;
              break;
            }
          }
          const end = State.model.snapshots[endIdx];
          const el = document.createElement('div');
          el.className = 'timeline-event drag-event';
          el.style.left = (start.timestamp/1000 * scale) + 'px';
          el.style.width = Math.max(8, (end.timestamp - start.timestamp)/1000 * scale) + 'px';
          el.title = base;
          track.appendChild(el);
          i = endIdx + 1;
        } else {
          if (!action.includes('drag')) {
            const el = document.createElement('div');
            el.className = 'timeline-event';
            el.style.left = (start.timestamp/1000 * scale) + 'px';
            el.title = action;
            track.appendChild(el);
          }
          i++;
        }
      }
      
      // Annotations
      State.model.annotations.forEach(a => {
        const el = document.createElement('div');
        el.className = 'timeline-annotation';
        el.style.left = (a.timestamp/1000 * scale) + 'px';
        el.style.width = (a.duration/1000 * scale) + 'px';
        const t = document.createElement('div'); t.innerHTML = a.content;
        el.textContent = t.textContent || 'Note';
        notes.appendChild(el);
      });
      
      // Pauses
      State.model.pauses.forEach(p => {
        const el = document.createElement('div');
        el.className = 'timeline-pause';
        el.style.left = (p.timestamp/1000 * scale) + 'px';
        wrapper.appendChild(el);
      });
    },
    
    renderPlayhead(now) {
      const ph = $('timelinePlayhead');
      ph.style.display = 'block';
      ph.style.left = (now/1000 * 50) + 60 + 'px'; // 60px offset matches CSS
    },
    
    importJSON(e) {
      const r = new FileReader();
      r.onload = (ev) => {
        State.model = JSON.parse(ev.target.result);
        this.renderTimeline();
        alert("Imported!");
      };
      r.readAsText(e.target.files[0]);
    }
  };

  window.onload = () => App.init();
})();
</script>
</body>
</html>
