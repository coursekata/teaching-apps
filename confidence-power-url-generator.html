<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Histogram URL Generator</title>
<style>
  body{
    margin:0;
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:#f5f5f5;
    padding:20px;
  }
  .container{
    max-width:900px;
    margin:0 auto;
    background:#fff;
    padding:30px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  h1{
    margin:0 0 10px;
    font-size:24px;
    color:#111;
  }
  .subtitle{
    color:#666;
    margin:0 0 30px;
    font-size:14px;
  }
  .section{
    margin:25px 0;
    padding:20px;
    background:#f9f9f9;
    border-radius:8px;
  }
  .section-title{
    font-weight:700;
    font-size:16px;
    margin:0 0 15px;
    color:#333;
  }
  .control-group{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    margin:15px 0;
  }
  .control{
    display:flex;
    flex-direction:column;
    gap:5px;
  }
  .control label{
    font-size:13px;
    font-weight:600;
    color:#555;
  }
  .control input[type="number"],
  .control input[type="text"],
  .control select{
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    font:inherit;
    background:#fff;
  }
  .control select:disabled{
    background:#f5f5f5;
    color:#999;
    cursor:not-allowed;
  }
  .checkbox-group{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
    margin:10px 0;
  }
  .checkbox-item{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .checkbox-item input[type="checkbox"]{
    width:18px;
    height:18px;
    cursor:pointer;
  }
  .checkbox-item label{
    font-size:13px;
    color:#555;
    cursor:pointer;
  }
  .url-output{
    margin:30px 0;
    padding:20px;
    background:#f0f7ff;
    border:2px solid #2563eb;
    border-radius:8px;
  }
  .url-output-title{
    font-weight:700;
    margin:0 0 10px;
    color:#1e40af;
  }
  .url-display{
    padding:12px;
    background:#fff;
    border:1px solid #cbd5e1;
    border-radius:6px;
    word-break:break-all;
    font-family:monospace;
    font-size:13px;
    color:#1e293b;
    max-height:150px;
    overflow-y:auto;
  }
  .button-group{
    display:flex;
    gap:10px;
    margin-top:15px;
  }
  button{
    padding:10px 20px;
    border:none;
    border-radius:6px;
    font:inherit;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s;
  }
  .btn-primary{
    background:#2563eb;
    color:#fff;
  }
  .btn-primary:hover{
    background:#1d4ed8;
  }
  .btn-secondary{
    background:#64748b;
    color:#fff;
  }
  .btn-secondary:hover{
    background:#475569;
  }
  .info-box{
    background:#fff3cd;
    border:1px solid #ffc107;
    border-radius:6px;
    padding:12px;
    margin:15px 0;
    font-size:13px;
    color:#856404;
  }
  .base-url-section{
    margin:20px 0;
    padding:15px;
    background:#e7f3ff;
    border-radius:8px;
  }
  .base-url-section label{
    display:block;
    font-weight:600;
    margin-bottom:8px;
    color:#333;
  }
  .base-url-section input{
    width:100%;
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    font:inherit;
  }
  .hex-input{
    font-family:monospace !important;
    text-transform:uppercase;
    font-size:13px;
  }
  .color-row{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .color-row input[type="color"]{
    flex:0 0 40px;
    height:40px;
    border:1px solid #ddd;
    border-radius:6px;
    cursor:pointer;
  }
  .color-row input[type="text"]{
    flex:1;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Confidence Power URL Generator</h1>
  <p class="subtitle">Configure the interactive visualization and generate a URL to share with students</p>

  <!-- Base URL Configuration -->
  <div class="base-url-section">
    <label>Base URL (update this to your hosted file location)</label>
    <input type="text" id="baseURL" value="https://coursekata.github.io/teaching-apps/confidence-demo-7.html" placeholder="https://coursekata.github.io/teaching-apps/confidence-demo-7.html">
  </div>

  <!-- Default Values Section -->
  <div class="section">
    <div class="section-title">Default Values</div>
    <div class="control-group">
      <div class="control">
        <label>Œ≤ (Population Parameter)</label>
        <input type="number" id="beta" value="" step="0.1" placeholder="Optional">
      </div>
      <div class="control">
        <label>b (Sample Statistic)</label>
        <input type="number" id="b" value="" step="0.1" placeholder="Optional">
      </div>
      <div class="control">
        <label>SE (Standard Error)</label>
        <input type="number" id="se" value="1" step="0.1" min="0.01">
      </div>
      <div class="control">
        <label>Bins</label>
        <input type="number" id="bins" value="30" min="1" max="200">
      </div>
      <div class="control">
        <label>Scale</label>
        <input type="number" id="scale" value="1.75" step="0.1" min="0.5" max="3">
      </div>
      <div class="control">
        <label>df (degrees of freedom)</label>
        <input type="number" id="df" value="10" min="1">
      </div>
    </div>
  </div>

  <!-- Initial State Section -->
  <div class="section">
    <div class="section-title">Initial State</div>
    <div class="control-group">
      <div class="control">
        <label>Curve Overlay</label>
        <select id="curve">
          <option value="off">Off</option>
          <option value="normal">Normal</option>
          <option value="t">t-distribution</option>
        </select>
      </div>
      <div class="control">
        <label>Alpha Level</label>
        <select id="alpha">
          <option value="off">Off</option>
          <option value=".10">Œ±=.10</option>
          <option value=".05">Œ±=.05</option>
          <option value=".01">Œ±=.01</option>
        </select>
      </div>
      <div class="control">
        <label>Histogram Display</label>
        <select id="histogram">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Second Distribution</label>
        <select id="seconddist">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Third Distribution</label>
        <select id="thirddist">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Power Mode</label>
        <select id="powermode">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Vertical Lines</label>
        <select id="vertlines">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>P-Value Display</label>
        <select id="p">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Custom Labels Section -->
  <div class="section">
    <div class="section-title">Custom Labels</div>
    <div class="info-box">
      Override default parameter labels. Leave blank to use LaTeX defaults: \beta, b, \bar{b}
    </div>
    <div class="control-group">
      <div class="control">
        <label>Population Parameter Label</label>
        <input type="text" id="label_param" value="" placeholder="\beta (default)">
      </div>
      <div class="control">
        <label>Sample Statistic Label</label>
        <input type="text" id="label_stat" value="" placeholder="b (default)">
      </div>
      <div class="control">
        <label>Sampling Mean Label</label>
        <input type="text" id="label_mean" value="" placeholder="\bar{b} (default)">
      </div>
    </div>
  </div>

  <!-- Custom Colors Section -->
  <div class="section">
    <div class="section-title">Custom Colors</div>
    <div class="info-box">
      Override default colors for different shading types. Use hex color codes (e.g., #ff5733). Leave blank to use defaults.
    </div>
    
    <!-- Color Preview -->
    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
      <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Live Preview</div>
      <svg id="colorPreview" width="100%" height="200" style="border: 1px solid #ddd; border-radius: 4px; background: white;">
        <!-- Main distribution curve -->
        <path id="mainCurve" fill="none" stroke="#1e4ed8" stroke-width="2"></path>
        <!-- Secondary distribution curve -->
        <path id="secondaryCurve" fill="none" stroke="#f97316" stroke-width="2"></path>
        
        <!-- Shading areas (in order from back to front) -->
        <path id="mainShading" fill="#60a5fa" fill-opacity="0.3"></path>
        <path id="alphaShading" fill="#1e3a8a" fill-opacity="0.25"></path>
        <path id="pShading" fill="#3b82f6" fill-opacity="0.25"></path>
        <path id="secondaryShading" fill="#f97316" fill-opacity="0.3"></path>
        <path id="powerShading" fill="#f97316" fill-opacity="0.4"></path>
        <path id="type2Shading" fill="#fbbf24" fill-opacity="0.3"></path>
        
        <!-- Responsive Legend -->
        <g id="previewLabels" font-family="system-ui" font-size="11" fill="#555">
          <text id="leftTitle" y="25" font-weight="600" text-anchor="middle">Main Distribution</text>
          <text id="rightTitle" y="25" font-weight="600" text-anchor="middle">Secondary Distribution</text>
          
          <!-- Main distribution legend (left) - Alpha, Main, P -->
          <text id="alphaLabel" y="180" text-anchor="middle">
            <tspan fill="#1e3a8a">‚ñ†</tspan> Alpha
          </text>
          <text id="mainLabel" y="180" text-anchor="middle">
            <tspan fill="#60a5fa">‚ñ†</tspan> Main
          </text>
          <text id="pLabel" y="180" text-anchor="middle">
            <tspan fill="#3b82f6">‚ñ†</tspan> P-value
          </text>
          
          <!-- Secondary distribution legend (right) - Type II, Power, Secondary -->
          <text id="type2Label" y="180" text-anchor="middle">
            <tspan fill="#fbbf24">‚ñ†</tspan> Type II
          </text>
          <text id="powerLabel" y="180" text-anchor="middle">
            <tspan fill="#e67e22">‚ñ†</tspan> Power
          </text>
          <text id="secondaryLabel" y="180" text-anchor="middle">
            <tspan fill="#f97316">‚ñ†</tspan> Secondary
          </text>
        </g>
      </svg>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Main Distribution Colors</div>
      <div class="control-group">
        <div class="control">
          <label>Main Distribution Color</label>
          <div class="color-row">
            <input type="color" id="main_color" value="#60a5fa">
            <input type="text" id="main_color_hex" value="#60a5fa" placeholder="#60a5fa" class="hex-input">
          </div>
        </div>
        <div class="control">
          <label>Alpha/CI Shading Color</label>
          <div class="color-row">
            <input type="color" id="alpha_color" value="#1e3a8a">
            <input type="text" id="alpha_color_hex" value="#1e3a8a" placeholder="#1e3a8a" class="hex-input">
          </div>
        </div>
        <div class="control">
          <label>P-Value Shading Color</label>
          <div class="color-row">
            <input type="color" id="p_color" value="#3b82f6">
            <input type="text" id="p_color_hex" value="#3b82f6" placeholder="#3b82f6" class="hex-input">
          </div>
        </div>
      </div>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Secondary Distribution Colors</div>
      <div class="control-group">
        <div class="control">
          <label>Secondary Distribution Color</label>
          <div class="color-row">
            <input type="color" id="secondary_color" value="#f97316">
            <input type="text" id="secondary_color_hex" value="#f97316" placeholder="#f97316" class="hex-input">
          </div>
        </div>
        <div class="control">
          <label>Power Shading Color</label>
          <div class="color-row">
            <input type="color" id="power_color" value="#e67e22">
            <input type="text" id="power_color_hex" value="#e67e22" placeholder="#e67e22" class="hex-input">
          </div>
        </div>
        <div class="control">
          <label>Type II Error & Alpha Color</label>
          <div class="color-row">
            <input type="color" id="type2_color" value="#fbbf24">
            <input type="text" id="type2_color_hex" value="#fbbf24" placeholder="#fbbf24" class="hex-input">
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin: 20px 0;">
      <button onclick="restoreDefaultColors()" style="padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px;">
        üîÑ Restore Default Colors
      </button>
    </div>
  </div>

  <!-- Hide Controls Section -->
  <div class="section">
    <div class="section-title">Hide Controls</div>
    <div class="info-box">
      Check the boxes below to hide controls from students
    </div>
    <div class="checkbox-group">
      <div class="checkbox-item">
        <input type="checkbox" id="hide_beta">
        <label for="hide_beta">Hide Œ≤</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_se">
        <label for="hide_se">Hide SE</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_seconddist">
        <label for="hide_seconddist">Hide Œ≤‚Ä≤</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_thirddist">
        <label for="hide_thirddist">Hide Œ≤‚Ä≥</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_powermode">
        <label for="hide_powermode">Hide Power Mode</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_b">
        <label for="hide_b">Hide b input</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_scale">
        <label for="hide_scale">Hide Scale</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_bins">
        <label for="hide_bins">Hide Bins</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_curve">
        <label for="hide_curve">Hide Curve</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_df">
        <label for="hide_df">Hide df</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_ci">
        <label for="hide_ci">Hide Alpha</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_vertlines">
        <label for="hide_vertlines">Hide Vert Lines</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_histogram">
        <label for="hide_histogram">Hide Histogram</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_p">
        <label for="hide_p">Hide P-Value</label>
      </div>
    </div>
  </div>

  <!-- Generated URL Section -->
  <div class="url-output">
    <div class="url-output-title">Generated URL</div>
    <div class="url-display" id="urlDisplay">Configure settings above and the URL will update automatically</div>
    <div class="button-group">
      <button class="btn-secondary" onclick="copyURL()">Copy to Clipboard</button>
      <button class="btn-primary" onclick="openPreview()">Open Preview</button>
    </div>
  </div>
</div>

<script>
function generateURL() {
  // Get base URL
  const baseURL = document.getElementById('baseURL').value.trim() || 'https://coursekata.github.io/teaching-apps/confidence-demo-7.html';
  
  // Get values with proper handling for empty strings
  const params = new URLSearchParams();
  
  // Default Values - only include if different from defaults
  if(document.getElementById('beta').value.trim()) params.append('beta', document.getElementById('beta').value.trim());
  if(document.getElementById('b').value.trim()) params.append('b', document.getElementById('b').value.trim());
  if(document.getElementById('se').value !== '1') params.append('se', document.getElementById('se').value);
  if(document.getElementById('bins').value !== '30') params.append('bins', document.getElementById('bins').value);
  if(document.getElementById('scale').value !== '1.75') params.append('scale', document.getElementById('scale').value);
  if(document.getElementById('df').value !== '10') params.append('df', document.getElementById('df').value);

  // Initial State
  if(document.getElementById('curve').value !== 'off') params.append('curve', document.getElementById('curve').value);
  if(document.getElementById('alpha').value !== 'off') params.append('alpha', document.getElementById('alpha').value);
  if(document.getElementById('histogram').value !== 'off') params.append('histogram', document.getElementById('histogram').value);
  if(document.getElementById('seconddist').value !== 'off') params.append('seconddist', document.getElementById('seconddist').value);
  if(document.getElementById('thirddist').value !== 'off') params.append('thirddist', document.getElementById('thirddist').value);
  if(document.getElementById('powermode').value !== 'off') params.append('powermode', document.getElementById('powermode').value);
  if(document.getElementById('vertlines').value !== 'off') params.append('vertlines', document.getElementById('vertlines').value);
  if(document.getElementById('p').value !== 'off') params.append('p', document.getElementById('p').value);
  
  // Custom Labels - automatically wrap in dollar signs for LaTeX if not already present
  if(document.getElementById('label_param').value.trim()) {
    let labelParam = document.getElementById('label_param').value.trim();
    if(!labelParam.startsWith('$')) labelParam = '$' + labelParam;
    if(!labelParam.endsWith('$')) labelParam = labelParam + '$';
    params.append('label_param', labelParam);
  }
  if(document.getElementById('label_stat').value.trim()) {
    let labelStat = document.getElementById('label_stat').value.trim();
    if(!labelStat.startsWith('$')) labelStat = '$' + labelStat;
    if(!labelStat.endsWith('$')) labelStat = labelStat + '$';
    params.append('label_stat', labelStat);
  }
  if(document.getElementById('label_mean').value.trim()) {
    let labelMean = document.getElementById('label_mean').value.trim();
    if(!labelMean.startsWith('$')) labelMean = '$' + labelMean;
    if(!labelMean.endsWith('$')) labelMean = labelMean + '$';
    params.append('label_mean', labelMean);
  }
  
  // Custom Colors (only if different from defaults)
  const defaultColors = {
    main_color: '#60a5fa',
    alpha_color: '#1e3a8a', 
    p_color: '#3b82f6',
    secondary_color: '#f97316',
    power_color: '#e67e22',
    type2_color: '#fbbf24'
  };
  
  Object.keys(defaultColors).forEach(colorKey => {
    const currentValue = document.getElementById(colorKey).value;
    if(currentValue !== defaultColors[colorKey]) {
      params.append(colorKey, currentValue);
    }
  });
  
  // Hide Controls - only append if checked
  const hideControls = [
    'hide_beta', 'hide_se', 'hide_seconddist', 'hide_thirddist',
    'hide_powermode', 'hide_b', 'hide_scale', 'hide_bins', 'hide_curve',
    'hide_df', 'hide_ci', 'hide_vertlines', 'hide_histogram', 'hide_p'
  ];
  
  hideControls.forEach(control => {
    if(document.getElementById(control).checked) {
      params.append(control, 'true');
    }
  });
  
  // Build URL
  let url = baseURL;
  if(params.toString()) {
    url += '?' + params.toString();
  }
  
  // Validation check
  let validationWarning = '';
  
  // Check if histogram is on but beta is not specified
  const betaValue = document.getElementById('beta').value.trim();
  const histogramValue = document.getElementById('histogram').value;
  
  if(histogramValue === 'on' && betaValue === '') {
    validationWarning = '‚ö†Ô∏è Warning: You must set a value for the population parameter in order to launch with a histogram visible.\n\n';
  }
  
  // Update display
  document.getElementById('urlDisplay').textContent = validationWarning + url;
}

function copyURL() {
  const urlText = document.getElementById('urlDisplay').textContent;
  
  // Check if there's a validation warning and extract just the URL
  const url = urlText.includes('‚ö†Ô∏è Warning:') ? 
    urlText.split('\n\n')[1] : urlText;
  
  // Try modern clipboard API first
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(url).then(function() {
      showCopySuccess();
    }).catch(function(err) {
      console.error('Clipboard API failed:', err);
      fallbackCopy(url);
    });
  } else {
    // Fallback for file:// URLs and older browsers
    fallbackCopy(url);
  }
}

function fallbackCopy(text) {
  // Create temporary textarea
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      showCopySuccess();
    } else {
      alert('Failed to copy URL. Please copy manually.');
    }
  } catch (err) {
    console.error('Fallback copy failed:', err);
    alert('Failed to copy URL. Please copy manually.');
  }
  
  document.body.removeChild(textarea);
}

function showCopySuccess() {
  const button = document.querySelector('button[onclick="copyURL()"]');
  if (!button) return;
  
  const originalText = button.textContent;
  button.textContent = '‚úì Copied!';
  button.style.background = '#10b981';
  
  setTimeout(() => {
    button.textContent = originalText;
    button.style.background = '#64748b';
  }, 2000);
}

function openPreview() {
  const url = document.getElementById('urlDisplay').textContent;
  
  // Check if there's a validation error
  if(url.includes('‚ö†Ô∏è Warning:') || url === '') {
    alert('Please fix the validation errors before opening a preview.');
    return;
  }
  
  window.open(url, '_blank');
}


// Color Preview Functions
function darkenColor(hex, amount = 0.3) {
  // Remove # if present
  hex = hex.replace('#', '');
  
  // Parse hex color
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);  
  let b = parseInt(hex.substring(4, 6), 16);
  
  // Darken by reducing RGB values
  r = Math.max(0, Math.floor(r * (1 - amount)));
  g = Math.max(0, Math.floor(g * (1 - amount)));
  b = Math.max(0, Math.floor(b * (1 - amount)));
  
  // Convert back to hex
  return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

function createColorPreview() {
  const svg = document.getElementById('colorPreview');
  const width = svg.getBoundingClientRect().width || 400; // Use actual rendered width
  const height = 200;
  
  // Don't set width attribute - let it stay 100% responsive
  svg.setAttribute('height', height);
  
  const margin = { top: 30, right: 20, bottom: 50, left: 20 };
  const plotWidth = width - margin.left - margin.right;
  const plotHeight = height - margin.top - margin.bottom;
  const baseline = height - margin.bottom;
  
  // Scale functions - make distributions larger and closer together
  const xScale = plotWidth / 2.5; // Wider distributions (was 3)
  const yScale = plotHeight * 0.9; // Taller distributions (was 0.8)
  
  function x(val) { return margin.left + (val + 1.25) * xScale; } // Closer together (was 1.5)
  function y(val) { return baseline - val * yScale; }
  
  // Normal distribution function
  function normalY(xVal, mean, std) {
    const z = (xVal - mean) / std;
    return (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * z * z);
  }
  
  // Generate curve points with extended range to support tail shading
  function generateCurve(mean, std) {
    const points = [];
    for (let i = 0; i <= 200; i++) {
      const xVal = -4 + (i / 200) * 8; // -4 to +4 (extended range)
      const yVal = normalY(xVal, mean, std);
      points.push([x(xVal), y(yVal)]);
    }
    return points;
  }
  
  // Generate shaded areas
  function generateArea(mean, std, leftBound, rightBound) {
    const points = [];
    const resolution = 100;
    
    for (let i = 0; i <= resolution; i++) {
      const xVal = leftBound + (i / resolution) * (rightBound - leftBound);
      const yVal = normalY(xVal, mean, std);
      points.push([x(xVal), y(yVal)]);
    }
    
    // Close the area at the bottom
    points.push([x(rightBound), baseline]);
    points.push([x(leftBound), baseline]);
    
    return points;
  }
  
  function pointsToPath(points) {
    if (points.length === 0) return '';
    return 'M' + points.map(p => p[0] + ',' + p[1]).join('L') + 'Z';
  }
  
  function lineToPath(points) {
    if (points.length === 0) return '';
    return 'M' + points.map(p => p[0] + ',' + p[1]).join('L');
  }
  
  // Main distribution (left side, no overlap)
  const mainMean = -0.7; // Moved further left to eliminate overlap
  const mainStd = 0.25;
  const mainPoints = generateCurve(mainMean, mainStd);
  
  // Secondary distribution (right side, no overlap)
  const secondaryMean = 0.7; // Moved further right to eliminate overlap
  const secondaryStd = 0.25;
  const secondaryPoints = generateCurve(secondaryMean, secondaryStd);
  
  // Update curves
  document.getElementById('mainCurve').setAttribute('d', lineToPath(mainPoints));
  document.getElementById('secondaryCurve').setAttribute('d', lineToPath(secondaryPoints));
  
  // MAIN DISTRIBUTION (Left) - COMPLETE TAIL COVERAGE ON BOTH SIDES
  // Alpha shading (left tail - extends way beyond boundary to ensure coverage)
  const alphaLeft = generateArea(mainMean, mainStd, -2.0, -0.95);   // Extended well beyond left boundary
  document.getElementById('alphaShading').setAttribute('d', pointsToPath(alphaLeft));
  
  // Main histogram color (center area)
  const mainArea = generateArea(mainMean, mainStd, -0.95, -0.55);
  document.getElementById('mainShading').setAttribute('d', pointsToPath(mainArea));
  
  // P-value shading (right portion - NOW EXTENDS TO FILL RIGHT TAIL COMPLETELY)
  const pArea = generateArea(mainMean, mainStd, -0.55, 0.2);  // Extended to fill right tail completely
  document.getElementById('pShading').setAttribute('d', pointsToPath(pArea));
  
  // SECONDARY DISTRIBUTION (Right) - COMPLETE TAIL COVERAGE ON BOTH SIDES  
  // Type II shading (left portion - NOW EXTENDS TO FILL LEFT TAIL COMPLETELY)
  const type2Area = generateArea(secondaryMean, secondaryStd, -0.2, 0.55);  // Extended to fill left tail completely
  document.getElementById('type2Shading').setAttribute('d', pointsToPath(type2Area));
  
  // Power shading (center section) 
  const powerArea = generateArea(secondaryMean, secondaryStd, 0.55, 0.95);
  document.getElementById('powerShading').setAttribute('d', pointsToPath(powerArea));
  
  // Secondary histogram color (right tail - extends way beyond boundary to ensure coverage)
  const secondaryArea = generateArea(secondaryMean, secondaryStd, 0.95, 2.0); // Extended well beyond right boundary
  document.getElementById('secondaryShading').setAttribute('d', pointsToPath(secondaryArea));
  
  // RESPONSIVE LEGEND POSITIONING
  updateLegendLayout(width);
}

function updateLegendLayout(svgWidth) {
  const margin = { top: 30, right: 20, bottom: 50, left: 20 };
  const plotWidth = svgWidth - margin.left - margin.right;
  const xScale = plotWidth / 2.5; // Same scale as distributions
  
  // Calculate actual SVG positions of distribution centers using same transform as distributions
  function x(val) { return margin.left + (val + 1.25) * xScale; }
  
  const leftDistCenter = x(-0.7);   // Actual position of main distribution center
  const rightDistCenter = x(0.7);   // Actual position of secondary distribution center
  
  // Position titles at distribution centers (text-anchor="middle" handles centering)
  document.getElementById('leftTitle').setAttribute('x', leftDistCenter);
  document.getElementById('rightTitle').setAttribute('x', rightDistCenter);
  
  // Left distribution legend - evenly spaced around center
  const spacing = 70; // Spacing for legend items
  
  document.getElementById('alphaLabel').setAttribute('x', leftDistCenter - spacing);
  document.getElementById('mainLabel').setAttribute('x', leftDistCenter);
  document.getElementById('pLabel').setAttribute('x', leftDistCenter + spacing);
  
  // Right distribution legend - evenly spaced around center
  document.getElementById('type2Label').setAttribute('x', rightDistCenter - spacing);
  document.getElementById('powerLabel').setAttribute('x', rightDistCenter);
  document.getElementById('secondaryLabel').setAttribute('x', rightDistCenter + spacing);
}

// Color sync functions for hex inputs
function syncColorToHex(colorId, hexId) {
  const colorValue = document.getElementById(colorId).value;
  document.getElementById(hexId).value = colorValue.toUpperCase();
}

function syncHexToColor(hexId, colorId) {
  const hexValue = document.getElementById(hexId).value.trim();
  // Validate hex color (support both #abc and #aabbcc formats)
  if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hexValue)) {
    document.getElementById(colorId).value = hexValue;
    // Update the hex input to ensure proper formatting
    document.getElementById(hexId).value = hexValue.toUpperCase();
    // Trigger updates
    updateColorPreview();
    generateURL();
  }
}

function setupColorSync() {
  const colorPairs = [
    ['main_color', 'main_color_hex'],
    ['alpha_color', 'alpha_color_hex'],
    ['p_color', 'p_color_hex'],
    ['secondary_color', 'secondary_color_hex'],
    ['power_color', 'power_color_hex'],
    ['type2_color', 'type2_color_hex']
  ];

  colorPairs.forEach(([colorId, hexId]) => {
    // Initialize hex input with uppercase value
    document.getElementById(hexId).value = document.getElementById(colorId).value.toUpperCase();
    
    // Sync color picker to hex input
    document.getElementById(colorId).addEventListener('change', () => syncColorToHex(colorId, hexId));
    document.getElementById(colorId).addEventListener('input', () => syncColorToHex(colorId, hexId));
    
    // Sync hex input to color picker
    document.getElementById(hexId).addEventListener('change', () => syncHexToColor(hexId, colorId));
    document.getElementById(hexId).addEventListener('input', () => {
      // Only trigger on valid hex during input for better UX
      const hexValue = document.getElementById(hexId).value.trim();
      if (/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hexValue)) {
        syncHexToColor(hexId, colorId);
      }
    });
  });
}

function updateColorPreview() {
  // Get current color values from the input controls
  const mainColor = document.getElementById('main_color').value;
  const alphaColor = document.getElementById('alpha_color').value; 
  const pColor = document.getElementById('p_color').value;
  const secondaryColor = document.getElementById('secondary_color').value;
  const powerColor = document.getElementById('power_color').value;
  const type2Color = document.getElementById('type2_color').value;
  
  // Generate stroke colors
  const mainStroke = darkenColor(mainColor, 0.4);
  const secondaryStroke = darkenColor(secondaryColor, 0.4);
  
  // Update shading areas with current colors
  const mainShading = document.getElementById('mainShading');
  const alphaShading = document.getElementById('alphaShading');
  const pShading = document.getElementById('pShading');
  const secondaryShading = document.getElementById('secondaryShading');
  const powerShading = document.getElementById('powerShading');
  const type2Shading = document.getElementById('type2Shading');
  
  if (mainShading) {
    mainShading.setAttribute('fill', mainColor);
    mainShading.setAttribute('fill-opacity', '0.3');
  }
  
  if (alphaShading) {
    alphaShading.setAttribute('fill', alphaColor);
    alphaShading.setAttribute('fill-opacity', '0.25');
  }
  
  if (pShading) {
    pShading.setAttribute('fill', pColor);
    pShading.setAttribute('fill-opacity', '0.25');
  }
  
  if (secondaryShading) {
    secondaryShading.setAttribute('fill', secondaryColor);
    secondaryShading.setAttribute('fill-opacity', '0.33');
  }
  
  if (powerShading) {
    powerShading.setAttribute('fill', powerColor);
    powerShading.setAttribute('fill-opacity', '0.4');
  }
  
  if (type2Shading) {
    type2Shading.setAttribute('fill', type2Color);
    type2Shading.setAttribute('fill-opacity', '0.3');
  }
  
  // Update curves with proper stroke colors
  const mainCurve = document.getElementById('mainCurve');
  const secondaryCurve = document.getElementById('secondaryCurve');
  
  if (mainCurve) mainCurve.setAttribute('stroke', mainStroke);
  if (secondaryCurve) secondaryCurve.setAttribute('stroke', secondaryStroke);
  
  // Update legend colors to match exactly - get the tspan elements correctly
  const alphaSpan = document.querySelector('#alphaLabel tspan');
  const mainSpan = document.querySelector('#mainLabel tspan');
  const pSpan = document.querySelector('#pLabel tspan');
  const type2Span = document.querySelector('#type2Label tspan');
  const powerSpan = document.querySelector('#powerLabel tspan');
  const secondarySpan = document.querySelector('#secondaryLabel tspan');
  
  if (alphaSpan) alphaSpan.setAttribute('fill', alphaColor);
  if (mainSpan) mainSpan.setAttribute('fill', mainColor);
  if (pSpan) pSpan.setAttribute('fill', pColor);
  if (type2Span) type2Span.setAttribute('fill', type2Color);
  if (powerSpan) powerSpan.setAttribute('fill', powerColor);
  if (secondarySpan) secondarySpan.setAttribute('fill', secondaryColor);
}

function restoreDefaultColors() {
  // Reset all color inputs to defaults
  document.getElementById('main_color').value = '#60a5fa';
  document.getElementById('alpha_color').value = '#1e3a8a';
  document.getElementById('p_color').value = '#3b82f6';
  document.getElementById('secondary_color').value = '#f97316';
  document.getElementById('power_color').value = '#e67e22';
  document.getElementById('type2_color').value = '#fbbf24';
  
  // Reset all hex inputs to defaults
  document.getElementById('main_color_hex').value = '#60A5FA';
  document.getElementById('alpha_color_hex').value = '#1E3A8A';
  document.getElementById('p_color_hex').value = '#3B82F6';
  document.getElementById('secondary_color_hex').value = '#F97316';
  document.getElementById('power_color_hex').value = '#E67E22';
  document.getElementById('type2_color_hex').value = '#FBBF24';
  
  // Update preview and URL
  updateColorPreview();
  generateURL();
}

// Setup color picker and hex input syncing first
setupColorSync();

// Auto-generate on any input change
document.querySelectorAll('input, select').forEach(element => {
  // Skip color and hex inputs as they have special handlers
  if (!element.type.includes('color') && !element.id.includes('_hex')) {
    element.addEventListener('change', generateURL);
    element.addEventListener('input', generateURL);
  }
});

// Add color preview update listeners for color pickers only
document.querySelectorAll('input[type="color"]').forEach(element => {
  element.addEventListener('change', () => {
    updateColorPreview();
    generateURL();
  });
  element.addEventListener('input', () => {
    updateColorPreview();
    generateURL();
  });
});

// Initialize color preview with a slight delay to ensure DOM is ready
setTimeout(() => {
  createColorPreview();
  updateColorPreview(); // Make sure colors are synced immediately
  generateURL(); // Generate initial URL
}, 100);

// Handle window resize for responsive preview
window.addEventListener('resize', () => {
  setTimeout(() => {
    createColorPreview();
    updateColorPreview(); // Re-sync colors after resize
  }, 100);
});

// Trigger a final color update to ensure everything is in sync
setTimeout(() => {
  updateColorPreview();
}, 200);

// Generate initial URL
generateURL();
</script>
</body>
</html>
