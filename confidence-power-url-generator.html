<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Histogram URL Generator</title>
<style>
  body{
    margin:0;
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:#f5f5f5;
    padding:20px;
  }
  .container{
    max-width:900px;
    margin:0 auto;
    background:#fff;
    padding:30px;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
  }
  h1{
    margin:0 0 10px;
    font-size:24px;
    color:#111;
  }
  .subtitle{
    color:#666;
    margin:0 0 30px;
    font-size:14px;
  }
  .section{
    margin:25px 0;
    padding:20px;
    background:#f9f9f9;
    border-radius:8px;
  }
  .section-title{
    font-weight:700;
    font-size:16px;
    margin:0 0 15px;
    color:#333;
  }
  .control-group{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
    margin:15px 0;
  }
  .control{
    display:flex;
    flex-direction:column;
    gap:5px;
  }
  .control label{
    font-size:13px;
    font-weight:600;
    color:#555;
  }
  .control input[type="number"],
  .control input[type="text"],
  .control select{
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    font:inherit;
    background:#fff;
  }
  .control select:disabled{
    background:#f5f5f5;
    color:#999;
    cursor:not-allowed;
  }
  .checkbox-group{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
    margin:10px 0;
  }
  .checkbox-item{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .checkbox-item input[type="checkbox"]{
    width:18px;
    height:18px;
    cursor:pointer;
  }
  .checkbox-item label{
    font-size:13px;
    color:#555;
    cursor:pointer;
  }
  .url-output{
    margin:30px 0;
    padding:20px;
    background:#f0f7ff;
    border:2px solid #2563eb;
    border-radius:8px;
  }
  .url-output-title{
    font-weight:700;
    margin:0 0 10px;
    color:#1e40af;
  }
  .url-display{
    padding:12px;
    background:#fff;
    border:1px solid #cbd5e1;
    border-radius:6px;
    word-break:break-all;
    font-family:monospace;
    font-size:13px;
    color:#1e293b;
    max-height:150px;
    overflow-y:auto;
  }
  .button-group{
    display:flex;
    gap:10px;
    margin-top:15px;
  }
  button{
    padding:10px 20px;
    border:none;
    border-radius:6px;
    font:inherit;
    font-weight:600;
    cursor:pointer;
    transition:all 0.2s;
  }
  .btn-primary{
    background:#2563eb;
    color:#fff;
  }
  .btn-primary:hover{
    background:#1d4ed8;
  }
  .btn-secondary{
    background:#64748b;
    color:#fff;
  }
  .btn-secondary:hover{
    background:#475569;
  }
  .info-box{
    background:#fff3cd;
    border:1px solid #ffc107;
    border-radius:6px;
    padding:12px;
    margin:15px 0;
    font-size:13px;
    color:#856404;
  }
  .base-url-section{
    margin:20px 0;
    padding:15px;
    background:#e7f3ff;
    border-radius:8px;
  }
  .base-url-section label{
    display:block;
    font-weight:600;
    margin-bottom:8px;
    color:#333;
  }
  .base-url-section input{
    width:100%;
    padding:8px 10px;
    border:1px solid #ddd;
    border-radius:6px;
    font:inherit;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Confidence Power URL Generator</h1>
  <p class="subtitle">Configure the interactive visualization and generate a URL to share with students</p>

  <!-- Base URL Configuration -->
  <div class="base-url-section">
    <label>Base URL (update this to your hosted file location)</label>
    <input type="text" id="baseURL" value="https://coursekata.github.io/teaching-apps/confidence-demo-7.html" placeholder="https://coursekata.github.io/teaching-apps/confidence-demo-7.html">
  </div>

  <!-- Default Values Section -->
  <div class="section">
    <div class="section-title">Default Values</div>
    <div class="control-group">
      <div class="control">
        <label>Œ≤ (Population Parameter)</label>
        <input type="number" id="beta" value="" step="0.1" placeholder="Optional">
      </div>
      <div class="control">
        <label>b (Sample Statistic)</label>
        <input type="number" id="b" value="" step="0.1" placeholder="Optional">
      </div>
      <div class="control">
        <label>SE (Standard Error)</label>
        <input type="number" id="se" value="1" step="0.1" min="0.01">
      </div>
      <div class="control">
        <label>Simulate Button Default</label>
        <select id="n">
          <option value="1" selected>1x</option>
          <option value="10">10x</option>
          <option value="100">100x</option>
          <option value="1000">1000x</option>
        </select>
      </div>
      <div class="control">
        <label>Bins</label>
        <input type="number" id="bins" value="30" min="1" max="200">
      </div>
      <div class="control">
        <label>Scale</label>
        <input type="number" id="scale" value="1.75" step="0.1" min="0.5" max="3">
      </div>
      <div class="control">
        <label>df (degrees of freedom)</label>
        <input type="number" id="df" value="10" min="1">
      </div>
    </div>
  </div>

  <!-- Initial State Section -->
  <div class="section">
    <div class="section-title">Initial State</div>
    <div class="control-group">
      <div class="control">
        <label>Curve Overlay</label>
        <select id="curve">
          <option value="off">Off</option>
          <option value="normal">Normal</option>
          <option value="t">t-distribution</option>
        </select>
      </div>
      <div class="control">
        <label>Alpha Level</label>
        <select id="alpha">
          <option value="off">Off</option>
          <option value=".10">Œ±=.10</option>
          <option value=".05">Œ±=.05</option>
          <option value=".01">Œ±=.01</option>
        </select>
      </div>
      <div class="control">
        <label>Histogram Display</label>
        <select id="histogram">
          <option value="on">On</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="control">
        <label>Second Distribution</label>
        <select id="seconddist">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Power Mode</label>
        <select id="powermode">
          <option value="tails">Tails</option>
          <option value="power">Power</option>
        </select>
      </div>
      <div class="control">
        <label>Vertical Lines</label>
        <select id="vertlines">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>P-Value Display</label>
        <select id="pvalue">
          <option value="off">Off</option>
          <option value="on">On</option>
        </select>
      </div>
      <div class="control">
        <label>Pregenerate Distribution</label>
        <select id="pregenerate" disabled title="Requires Œ≤ to be specified">
          <option value="false">No</option>
          <option value="true">Yes (1000 samples)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Labels Section -->
  <div class="section">
    <div class="section-title">Custom Labels (LaTeX)</div>
    <div class="info-box">
      Use LaTeX notation (e.g., \mu, \bar{x}, \beta_1). $ delimiters will be added automatically. Separate with commas. Leave blank to use defaults.
    </div>
    <div class="control-group">
      <div class="control">
        <label>Population Parameter Label</label>
        <input type="text" id="label_param" value="" placeholder="\beta (default)">
      </div>
      <div class="control">
        <label>Sample Statistic Label</label>
        <input type="text" id="label_stat" value="" placeholder="b (default)">
      </div>
      <div class="control">
        <label>Sampling Mean Label</label>
        <input type="text" id="label_mean" value="" placeholder="\bar{b} (default)">
      </div>
    </div>
  </div>

  <!-- Custom Colors Section -->
  <div class="section">
    <div class="section-title">Custom Colors</div>
    <div class="info-box">
      Override default colors for different shading types. Use hex color codes (e.g., #ff5733). Leave blank to use defaults.
    </div>
    
    <!-- Color Preview -->
    <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 8px;">
      <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Live Preview</div>
      <svg id="colorPreview" width="100%" height="200" style="border: 1px solid #ddd; border-radius: 4px; background: white;">
        <!-- Main distribution curve -->
        <path id="mainCurve" fill="none" stroke="#1e4ed8" stroke-width="2"></path>
        <!-- Secondary distribution curve -->
        <path id="secondaryCurve" fill="none" stroke="#f97316" stroke-width="2"></path>
        
        <!-- Shading areas (in order from back to front) -->
        <path id="mainShading" fill="#60a5fa" fill-opacity="0.3"></path>
        <path id="alphaShading" fill="#1e3a8a" fill-opacity="0.25"></path>
        <path id="pShading" fill="#3b82f6" fill-opacity="0.25"></path>
        <path id="secondaryShading" fill="#f97316" fill-opacity="0.3"></path>
        <path id="powerShading" fill="#f97316" fill-opacity="0.4"></path>
        <path id="type2Shading" fill="#fbbf24" fill-opacity="0.3"></path>
        
        <!-- Labels -->
        <g id="previewLabels" font-family="system-ui" font-size="11" fill="#555">
          <text x="100" y="25" font-weight="600">Main Distribution (Left)</text>
          <text x="320" y="25" font-weight="600">Secondary Distribution (Right)</text>
          
          <!-- Main distribution legend (left) -->
          <text x="30" y="180">
            <tspan fill="#1e3a8a">‚ñ†</tspan> Alpha
          </text>
          <text x="70" y="180">
            <tspan fill="#60a5fa">‚ñ†</tspan> Main
          </text>
          <text x="110" y="180">
            <tspan fill="#3b82f6">‚ñ†</tspan> P
          </text>
          <text x="140" y="180">
            <tspan fill="#1e3a8a">‚ñ†</tspan> Alpha
          </text>
          
          <!-- Secondary distribution legend (right) -->
          <text x="240" y="180">
            <tspan fill="#fbbf24">‚ñ†</tspan> Type II
          </text>
          <text x="285" y="180">
            <tspan fill="#e67e22">‚ñ†</tspan> Power
          </text>
          <text x="325" y="180">
            <tspan fill="#f97316">‚ñ†</tspan> Secondary
          </text>
        </g>
      </svg>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Main Distribution Colors</div>
      <div class="control-group">
        <div class="control">
          <label>Main Distribution Color</label>
          <input type="color" id="main_color" value="#60a5fa">
        </div>
        <div class="control">
          <label>Alpha/CI Shading Color</label>
          <input type="color" id="alpha_color" value="#1e3a8a">
        </div>
        <div class="control">
          <label>P-Value Shading Color</label>
          <input type="color" id="p_color" value="#3b82f6">
        </div>
      </div>
    </div>
    
    <div style="margin: 15px 0;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #333;">Secondary Distribution Colors</div>
      <div class="control-group">
        <div class="control">
          <label>Secondary Distribution Color</label>
          <input type="color" id="secondary_color" value="#f97316">
        </div>
        <div class="control">
          <label>Power Shading Color</label>
          <input type="color" id="power_color" value="#e67e22">
        </div>
        <div class="control">
          <label>Type II Error Color</label>
          <input type="color" id="type2_color" value="#fbbf24">
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin: 20px 0;">
      <button onclick="restoreDefaultColors()" style="padding: 8px 16px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer; font-size: 14px;">
        üîÑ Restore Default Colors
      </button>
    </div>
  </div>

  <!-- Hide Controls Section -->
  <div class="section">
    <div class="section-title">Hide Controls</div>
    <div class="info-box">
      Check the boxes below to hide controls from students
    </div>
    <div class="checkbox-group">
      <div class="checkbox-item">
        <input type="checkbox" id="hide_beta">
        <label for="hide_beta">Hide Œ≤</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_se">
        <label for="hide_se">Hide SE</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_simulate">
        <label for="hide_simulate">Hide Simulate</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_seconddist">
        <label for="hide_seconddist">Hide Œ≤‚Ä≤</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_thirddist">
        <label for="hide_thirddist">Hide Œ≤‚Ä≥</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_powermode">
        <label for="hide_powermode">Hide Power Mode</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_b">
        <label for="hide_b">Hide b input</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_scale">
        <label for="hide_scale">Hide Scale</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_bins">
        <label for="hide_bins">Hide Bins</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_curve">
        <label for="hide_curve">Hide Curve</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_df">
        <label for="hide_df">Hide df</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_ci">
        <label for="hide_ci">Hide Alpha</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_vertlines">
        <label for="hide_vertlines">Hide Vert Lines</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_histogram">
        <label for="hide_histogram">Hide Histogram</label>
      </div>
      <div class="checkbox-item">
        <input type="checkbox" id="hide_p">
        <label for="hide_p">Hide P-Value</label>
      </div>
    </div>
  </div>

  <!-- Generated URL Section -->
  <div class="url-output">
    <div class="url-output-title">Generated URL</div>
    <div class="url-display" id="urlDisplay">Configure settings above and the URL will update automatically</div>
    <div class="button-group">
      <button class="btn-secondary" onclick="copyURL()">Copy to Clipboard</button>
      <button class="btn-primary" onclick="openPreview()">Open Preview</button>
    </div>
  </div>
</div>

<script>
function generateURL() {
  // Get base URL
  const baseURL = document.getElementById('baseURL').value.trim() || 'https://coursekata.github.io/teaching-apps/confidence-demo-7.html';
  
  const params = new URLSearchParams();
  
  // Add default values (only if different from defaults)
  const beta = document.getElementById('beta').value;
  const b = document.getElementById('b').value;
  const se = document.getElementById('se').value;
  const n = document.getElementById('n').value;
  const bins = document.getElementById('bins').value;
  const scale = document.getElementById('scale').value;
  const df = document.getElementById('df').value;
  
  if(beta !== '') params.append('beta', beta);
  if(b !== '') params.append('b', b);
  if(se !== '1') params.append('se', se);
  if(n !== '1') params.append('n', n);
  if(bins !== '30') params.append('bins', bins);
  if(scale !== '1.75') params.append('scale', scale);
  if(df !== '10') params.append('df', df);
  
  // Add initial states
  const curve = document.getElementById('curve').value;
  const alpha = document.getElementById('alpha').value;
  const histogram = document.getElementById('histogram').value;
  const seconddist = document.getElementById('seconddist').value;
  const powermode = document.getElementById('powermode').value;
  const vertlines = document.getElementById('vertlines').value;
  const pvalue = document.getElementById('pvalue').value;
  const pregenerate = document.getElementById('pregenerate').value;
  
  // Validate pregenerate requirements
  if(pregenerate === 'true' && beta === '') {
    document.getElementById('urlDisplay').innerHTML = '<span style="color:#dc2626;">‚ö†Ô∏è Warning: Pre-Generate Sampling Distribution requires a Œ≤ (Population Parameter) value to be specified.</span>';
    return '';
  }
  
  if(curve !== 'off') params.append('curve', curve);
  if(alpha !== 'off') params.append('alpha', alpha);
  if(histogram !== 'on') params.append('histogram', histogram);
  if(seconddist !== 'off') params.append('seconddist', seconddist);
  if(powermode !== 'tails') params.append('powermode', powermode);
  if(vertlines !== 'off') params.append('vertlines', vertlines);
  if(pvalue !== 'off') params.append('pvalue', pvalue);
  if(pregenerate !== 'false') params.append('pregenerate', pregenerate);
  
  // Add labels (only if provided)
  const labelParam = document.getElementById('label_param').value.trim();
  const labelStat = document.getElementById('label_stat').value.trim();
  const labelMean = document.getElementById('label_mean').value.trim();
  
  if(labelParam || labelStat || labelMean) {
    // Wrap each label in $ delimiters for LaTeX notation
    const labels = [
      labelParam ? `$${labelParam}$` : '$\\beta$', 
      labelStat ? `$${labelStat}$` : '$b$', 
      labelMean ? `$${labelMean}$` : '$\\bar{b}$'
    ];
    params.append('labels', labels.join(','));
  }
  
  // Add custom colors (only if different from defaults)
  const defaultColors = {
    'main_color': '#60a5fa',
    'alpha_color': '#1e3a8a', 
    'p_color': '#3b82f6',
    'secondary_color': '#f97316',
    'power_color': '#e67e22',
    'type2_color': '#fbbf24'
  };
  
  Object.keys(defaultColors).forEach(colorParam => {
    const colorValue = document.getElementById(colorParam).value;
    if(colorValue && colorValue.toLowerCase() !== defaultColors[colorParam].toLowerCase()) {
      params.append(colorParam, colorValue);
    }
  });
  
  // Add hide controls
  const hideControls = [
    'hide_beta', 'hide_se', 'hide_simulate',
    'hide_seconddist', 'hide_thirddist', 'hide_powermode', 'hide_b',
    'hide_scale', 'hide_bins', 'hide_curve', 'hide_df',
    'hide_ci', 'hide_vertlines', 'hide_histogram', 'hide_p'
  ];
  
  hideControls.forEach(control => {
    if(document.getElementById(control).checked) {
      params.append(control, 'true');
    }
  });
  
  // Generate final URL
  const finalURL = params.toString() ? `${baseURL}?${params.toString()}` : baseURL;
  document.getElementById('urlDisplay').textContent = finalURL;
  
  return finalURL;
}

function copyURL() {
  const url = document.getElementById('urlDisplay').textContent;
  
  // Check if there's a validation error
  if(url.includes('‚ö†Ô∏è Warning:') || url === '') {
    alert('Please fix the validation errors before copying the URL.');
    return;
  }
  
  navigator.clipboard.writeText(url).then(() => {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Copied!';
    btn.style.background = '#10b981';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = '';
    }, 2000);
  }).catch(err => {
    console.error('Failed to copy:', err);
    alert('Failed to copy URL. Please copy manually.');
  });
}

function openPreview() {
  const url = document.getElementById('urlDisplay').textContent;
  
  // Check if there's a validation error
  if(url.includes('‚ö†Ô∏è Warning:') || url === '') {
    alert('Please fix the validation errors before opening a preview.');
    return;
  }
  
  window.open(url, '_blank');
}

// Function to check if pregenerate should be enabled
function updatePregenerateState() {
  const beta = document.getElementById('beta').value.trim();
  const pregenerateSelect = document.getElementById('pregenerate');
  
  if(beta === '') {
    // No beta value - disable and reset to 'false'
    pregenerateSelect.disabled = true;
    pregenerateSelect.value = 'false';
    pregenerateSelect.title = 'Requires Œ≤ to be specified';
  } else {
    // Beta has a value - enable the dropdown
    pregenerateSelect.disabled = false;
    pregenerateSelect.title = '';
  }
}

// Color Preview Functions
function darkenColor(hex, amount = 0.3) {
  // Remove # if present
  hex = hex.replace('#', '');
  
  // Parse hex color
  let r = parseInt(hex.substring(0, 2), 16);
  let g = parseInt(hex.substring(2, 4), 16);  
  let b = parseInt(hex.substring(4, 6), 16);
  
  // Darken by reducing RGB values
  r = Math.max(0, Math.floor(r * (1 - amount)));
  g = Math.max(0, Math.floor(g * (1 - amount)));
  b = Math.max(0, Math.floor(b * (1 - amount)));
  
  // Convert back to hex
  return '#' + ((r << 16) | (g << 8) | b).toString(16).padStart(6, '0');
}

function createColorPreview() {
  const svg = document.getElementById('colorPreview');
  const width = svg.getBoundingClientRect().width || 400; // Use actual rendered width
  const height = 200;
  
  // Don't set width attribute - let it stay 100% responsive
  svg.setAttribute('height', height);
  
  const margin = { top: 30, right: 20, bottom: 50, left: 20 };
  const plotWidth = width - margin.left - margin.right;
  const plotHeight = height - margin.top - margin.bottom;
  const baseline = height - margin.bottom;
  
  // Scale functions - use much narrower domain to make distributions larger
  const xScale = plotWidth / 3; // Show only 3 units instead of 8
  const yScale = plotHeight * 0.8;
  
  function x(val) { return margin.left + (val + 1.5) * xScale; } // Center around 0, show -1.5 to +1.5
  function y(val) { return baseline - val * yScale; }
  
  // Normal distribution function
  function normalY(xVal, mean, std) {
    const z = (xVal - mean) / std;
    return (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * z * z);
  }
  
  // Generate curve points
  function generateCurve(mean, std) {
    const points = [];
    for (let i = 0; i <= 200; i++) {
      const xVal = -4 + (i / 200) * 8; // -4 to +4
      const yVal = normalY(xVal, mean, std);
      points.push([x(xVal), y(yVal)]);
    }
    return points;
  }
  
  // Generate shaded areas
  function generateArea(mean, std, leftBound, rightBound) {
    const points = [];
    const resolution = 100;
    
    for (let i = 0; i <= resolution; i++) {
      const xVal = leftBound + (i / resolution) * (rightBound - leftBound);
      const yVal = normalY(xVal, mean, std);
      points.push([x(xVal), y(yVal)]);
    }
    
    // Close the area at the bottom
    points.push([x(rightBound), baseline]);
    points.push([x(leftBound), baseline]);
    
    return points;
  }
  
  function pointsToPath(points) {
    if (points.length === 0) return '';
    return 'M' + points.map(p => p[0] + ',' + p[1]).join('L') + 'Z';
  }
  
  function lineToPath(points) {
    if (points.length === 0) return '';
    return 'M' + points.map(p => p[0] + ',' + p[1]).join('L');
  }
  
  // Main distribution (left side, completely separate)
  const mainMean = -0.8;
  const mainStd = 0.2; // Tighter for clearer color regions
  const mainPoints = generateCurve(mainMean, mainStd);
  
  // Secondary distribution (right side, completely separate)
  const secondaryMean = 0.8;
  const secondaryStd = 0.2; // Tighter for clearer color regions
  const secondaryPoints = generateCurve(secondaryMean, secondaryStd);
  
  // Update curves
  document.getElementById('mainCurve').setAttribute('d', lineToPath(mainPoints));
  document.getElementById('secondaryCurve').setAttribute('d', lineToPath(secondaryPoints));
  
  // MAIN DISTRIBUTION (Left) - Clear regions with proper order
  // Alpha shading (both outer tails)
  const alphaLeft = generateArea(mainMean, mainStd, -1.3, -1.05);  // Far left tail
  const alphaRight = generateArea(mainMean, mainStd, -0.55, -0.3); // Right tail
  document.getElementById('alphaShading').setAttribute('d', pointsToPath(alphaLeft) + ' ' + pointsToPath(alphaRight));
  
  // Main histogram color (center)
  const mainArea = generateArea(mainMean, mainStd, -1.05, -0.65);
  document.getElementById('mainShading').setAttribute('d', pointsToPath(mainArea));
  
  // P-value shading (small region to the left of right alpha area)
  const pArea = generateArea(mainMean, mainStd, -0.65, -0.55);
  document.getElementById('pShading').setAttribute('d', pointsToPath(pArea));
  
  // SECONDARY DISTRIBUTION (Right) - Three clear sections filling to tails
  // Type II shading (left tail)
  const type2Area = generateArea(secondaryMean, secondaryStd, 0.3, 0.6);
  document.getElementById('type2Shading').setAttribute('d', pointsToPath(type2Area));
  
  // Power shading (middle section) 
  const powerArea = generateArea(secondaryMean, secondaryStd, 0.6, 0.9);
  document.getElementById('powerShading').setAttribute('d', pointsToPath(powerArea));
  
  // Secondary histogram color (right section to tail)
  const secondaryArea = generateArea(secondaryMean, secondaryStd, 0.9, 1.3);
  document.getElementById('secondaryShading').setAttribute('d', pointsToPath(secondaryArea));
}

function updateColorPreview() {
  // Get current color values
  const mainColor = document.getElementById('main_color').value;
  const alphaColor = document.getElementById('alpha_color').value; 
  const pColor = document.getElementById('p_color').value;
  const secondaryColor = document.getElementById('secondary_color').value;
  const powerColor = document.getElementById('power_color').value;
  const type2Color = document.getElementById('type2_color').value;
  
  // Generate stroke colors
  const mainStroke = darkenColor(mainColor, 0.4);
  const secondaryStroke = darkenColor(secondaryColor, 0.4);
  
  // Update shading areas
  document.getElementById('mainShading').setAttribute('fill', mainColor);
  document.getElementById('mainShading').setAttribute('fill-opacity', '0.3');
  
  document.getElementById('alphaShading').setAttribute('fill', alphaColor);
  document.getElementById('alphaShading').setAttribute('fill-opacity', '0.25');
  
  document.getElementById('pShading').setAttribute('fill', pColor);
  document.getElementById('pShading').setAttribute('fill-opacity', '0.25');
  
  // Secondary should be much lighter (like #f9731655 = ~33% opacity)
  document.getElementById('secondaryShading').setAttribute('fill', secondaryColor);
  document.getElementById('secondaryShading').setAttribute('fill-opacity', '0.33');
  
  document.getElementById('powerShading').setAttribute('fill', powerColor);
  document.getElementById('powerShading').setAttribute('fill-opacity', '0.4');
  
  document.getElementById('type2Shading').setAttribute('fill', type2Color);
  document.getElementById('type2Shading').setAttribute('fill-opacity', '0.3');
  
  // Update curves with proper stroke colors
  document.getElementById('mainCurve').setAttribute('stroke', mainStroke);
  document.getElementById('secondaryCurve').setAttribute('stroke', secondaryStroke);
  
  // Update legend colors
  const labels = document.getElementById('previewLabels').querySelectorAll('tspan');
  if (labels[0]) labels[0].setAttribute('fill', mainColor);
  if (labels[1]) labels[1].setAttribute('fill', alphaColor);
  if (labels[2]) labels[2].setAttribute('fill', pColor);
  if (labels[3]) labels[3].setAttribute('fill', secondaryColor);
  if (labels[4]) labels[4].setAttribute('fill', powerColor);
  if (labels[5]) labels[5].setAttribute('fill', type2Color);
}

function restoreDefaultColors() {
  // Reset all color inputs to defaults
  document.getElementById('main_color').value = '#60a5fa';
  document.getElementById('alpha_color').value = '#1e3a8a';
  document.getElementById('p_color').value = '#3b82f6';
  document.getElementById('secondary_color').value = '#f97316';
  document.getElementById('power_color').value = '#e67e22';
  document.getElementById('type2_color').value = '#fbbf24';
  
  // Update preview and URL
  updateColorPreview();
  generateURL();
}

// Auto-generate on any input change
document.querySelectorAll('input, select').forEach(element => {
  element.addEventListener('change', generateURL);
  element.addEventListener('input', generateURL);
});

// Add color preview update listeners
document.querySelectorAll('input[type="color"]').forEach(element => {
  element.addEventListener('change', updateColorPreview);
  element.addEventListener('input', updateColorPreview);
});

// Special listener for beta input to update pregenerate state
document.getElementById('beta').addEventListener('input', updatePregenerateState);
document.getElementById('beta').addEventListener('change', updatePregenerateState);

// Initialize pregenerate state
updatePregenerateState();

// Initialize color preview
setTimeout(() => {
  createColorPreview();
  updateColorPreview();
}, 100);

// Handle window resize for responsive preview
window.addEventListener('resize', () => {
  setTimeout(() => {
    createColorPreview();
    updateColorPreview();
  }, 100);
});

// Generate initial URL
generateURL();
</script>
</body>
</html>
