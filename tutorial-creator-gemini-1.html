<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Interactive Tutorial Creator - v13.48 (Fixed)</title>
<script>
  window.MathJax = {
    tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
    startup: { ready: () => MathJax.startup.defaultReady() }
  };
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js"></script>
<style>
  /* --- CORE STYLES --- */
  :root{ --accent:#2563eb; --record:#ef4444; --success:#10b981; --warning:#f59e0b; --teal:#06b6d4; }
  body{ margin:0; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:#111; background:#f5f5f5; }
  
  /* HEADER */
  .tutorial-header{ position: sticky; top: 0; background:#fff; border-bottom:2px solid #ddd; padding:12px 20px; box-shadow:0 2px 4px rgba(0,0,0,0.05); z-index: 100; display: flex; justify-content: space-between; align-items: center; }
  .version-number{ color: #666; font-size: 12px; font-weight: 500; }
  .tutorial-controls{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  
  /* BUTTONS */
  button{ padding:8px 14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:13px; }
  button:hover:not(:disabled):not(.colored){ background:#f9f9f9; }
  button:disabled{ opacity:0.5; cursor:not-allowed; }
  button.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
  button.record{ background:var(--record); color:#fff; border-color:var(--record); }
  button.success{ background:var(--success); color:#fff; border-color:var(--success); }
  button.warning{ background:var(--warning); color:#fff; border-color:var(--warning); }
  button.teal{ background:var(--teal); color:#fff; border-color:var(--teal); }
  
  /* ANIMATIONS */
  @keyframes pulse{ 0%,100%{opacity:1} 50%{opacity:0.6} }
  .recording-active{ animation:pulse 1.5s infinite; }
  .recording-indicator{ background:var(--record); color:#fff; padding:6px 12px; border-radius:20px; font-weight:600; font-size:13px; animation:pulse 1.5s infinite; }
  .paused-indicator{ background:var(--warning); color:#fff; padding:6px 12px; border-radius:20px; font-weight:600; font-size:13px; }
  
  /* LAYOUT */
  .app-container{ position:relative; width:1000px; height:800px; overflow:hidden; margin:0 auto 40px auto; border:1px solid #ddd; border-radius:8px; background: white; }
  iframe{ width:1000px; height:100%; border:none; }
  iframe.playback-mode{ pointer-events:none; }
  
  /* TIMELINE - Critical for visuals */
  .timeline-container{ background:#fff; border-top:2px solid #ddd; border-bottom:2px solid #ddd; padding:4px 20px 6px 20px; display:none; position:relative; margin-bottom:8px; overflow-x: auto; }
  .timeline-container.visible{ display:block; }
  
  .timeline-wrapper { position: relative; min-width: 100%; } /* Ensures resizing works */

  .timeline-ruler{ height:14px; position:relative; margin-left:60px; border-bottom: 1px solid #eee; }
  .timeline-tick{ position:absolute; top:0; font-size:9px; color:#999; border-left: 1px solid #eee; height: 100%; padding-left: 2px; }
  
  .timeline-track{ height:26px; background:#fafafa; border:1px solid #ddd; border-radius:4px; position:relative; margin-bottom:2px; margin-left: 60px; }
  .timeline-track-label{ position:absolute; left:0; top:50%; transform:translateY(-50%); font-size:9px; font-weight:600; color:#666; width:55px; text-align:right; padding-right:5px; pointer-events: none; margin-left: -60px; }
  
  /* Timeline Items */
  .timeline-event{ position:absolute; top:4px; bottom:4px; width:8px; background:#6366f1; border-radius:2px; cursor:move; z-index:1; box-shadow:0 1px 3px rgba(99,102,241,0.3); }
  .timeline-event.drag-event{ width:auto; background:#8b5cf6; opacity: 0.8; }
  .timeline-event:hover{ background:#4f46e5; z-index: 2; opacity: 1; }
  
  .timeline-annotation{ position:absolute; top:4px; bottom:4px; background:linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius:3px; color:#fff; font-size:10px; padding:0 6px; display:flex; align-items:center; cursor:move; white-space:nowrap; overflow:hidden; z-index:2; border:1px solid rgba(255,255,255,0.2); }
  
  .timeline-pause{ position:absolute; top:40px; width:12px; height:12px; background:#f59e0b; transform:translateY(-50%) rotate(45deg); cursor:move; z-index:10; border:1px solid rgba(255,255,255,0.3); margin-left: 60px; }
  
  .timeline-playhead{ position:absolute; top:14px; height:60px; width:2px; background:#ef4444; pointer-events:none; z-index:9999; margin-left: 60px; }
  .timeline-playhead::before{ content:''; position:absolute; top:-8px; left:50%; transform:translateX(-50%); width:12px; height:12px; background:#ef4444; border-radius:50%; border:2px solid #fff; cursor:grab; pointer-events:auto; }
  
  /* MODALS */
  .modal-overlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:2000; }
  .modal-overlay.visible{ display:flex; }
  .modal{ background:#fff; border-radius:12px; padding:24px; max-width:700px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.2); }
  .modal h2{ margin:0 0 16px; }
  .info-box{ background:#e0f2fe; border:1px solid #0284c7; border-radius:8px; padding:12px; margin:12px 0; font-size:13px; color:#0c4a6e; }
  .form-group{ margin-bottom:16px; }
  .form-group label{ display:block; margin-bottom:6px; font-weight:600; color:#374151; }
  textarea, input[type=text], input[type=number]{ width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; font-family:inherit; box-sizing: border-box; }
  .modal-buttons{ display:flex; gap:8px; margin-top:16px; justify-content:flex-end; }

  /* Utility */
  .control-group{ display:flex; gap:8px; align-items:center; }
  input.url-input { width: 300px; }
</style>
</head>
<body>

<div class="tutorial-header">
  <div class="tutorial-controls">
    <div class="control-group">
      <label>App URL: <input type="text" id="appUrl" class="url-input" placeholder="e.g. confidence-demo.html" value=""/></label>
      <button id="loadApp" class="primary">Load App</button>
      
      <button id="startRecording" class="record" style="display:none;">‚è∫ Record</button>
      <button id="pauseRecording" class="warning" style="display:none;">‚è∏ Pause</button>
      <button id="resumeRecording" class="record" style="display:none;">‚è∫ Resume</button>
      
      <button id="addAnnotation" class="teal" style="display:none;">+Text</button>
      <button id="addPause" class="warning" style="display:none;">+Pause</button>
      <button id="preview" class="primary" style="display:none;">‚ñ∂ Preview</button>
      
      <button id="importBtn" class="success" style="display:none;">Import</button>
      <button id="exportBtn" class="success" style="display:none;">Export</button>
      <button id="stylesBtn" class="teal" style="display:none;">Styles</button>
      
      <span id="statusIndicator" class="paused-indicator" style="display:none;">READY</span>
    </div>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
  </div>
  <div class="version-number">v2.1 (Stable)</div>
</div>

<div id="timelineContainer" class="timeline-container">
  <div class="timeline-wrapper" id="timelineWrapper">
    <div id="timelineRuler" class="timeline-ruler"></div>
    <div class="timeline-track">
      <div class="timeline-track-label">Events</div>
      <div id="eventsTrack"></div>
    </div>
    <div class="timeline-track">
      <div class="timeline-track-label">Notes</div>
      <div id="annotationsTrack"></div>
    </div>
    <div id="timelinePlayhead" class="timeline-playhead" style="display:none;"></div>
  </div>
</div>

<div class="app-container">
  <iframe id="appFrame" sandbox="allow-scripts allow-same-origin"></iframe>
</div>

<div id="annotationModal" class="modal-overlay">
  <div class="modal">
    <h2>Edit Annotation</h2>
    <div class="info-box">Use HTML for content. Use CSS classes defined in 'Styles'.</div>
    <div class="form-group"><label>Content</label><textarea id="annContent" rows="4"></textarea></div>
    <div class="form-group"><label>CSS (Optional)</label><textarea id="annCSS" rows="2"></textarea></div>
    <div class="form-group"><label>Duration (s)</label><input type="number" id="annDuration" value="5"></div>
    <div class="modal-buttons"><button id="annCancel">Cancel</button><button id="annNext" class="primary">Next: Position</button></div>
  </div>
</div>

<div id="stylesModal" class="modal-overlay">
  <div class="modal">
    <h2>Global Styles</h2>
    <textarea id="globalStylesContent" style="width:100%;height:300px;font-family:monospace;"></textarea>
    <div class="modal-buttons"><button id="stylesCancel">Cancel</button><button id="stylesSave" class="primary">Save</button></div>
  </div>
</div>

<div id="posOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;pointer-events:none;">
  <div style="position:absolute;top:20px;left:50%;transform:translateX(-50%);background:#fff;padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.2);pointer-events:auto;">
    <div style="font-weight:bold;margin-bottom:8px">üìç Position Annotation</div>
    <div style="display:flex;gap:8px"><button id="posSave" class="success">Save</button><button id="posDelete" class="record">Delete</button></div>
  </div>
</div>

<div id="exportModal" class="modal-overlay">
  <div class="modal">
    <h2>Export JSON</h2>
    <textarea id="exportTextarea" style="width:100%;height:300px;" readonly></textarea>
    <div class="modal-buttons"><button id="closeExport">Close</button></div>
  </div>
</div>

<script>
/* REFACTORED ENGINE */

const Utils = {
  id: i => document.getElementById(i),
  show: i => document.getElementById(i).style.display = 'inline-block',
  hide: i => document.getElementById(i).style.display = 'none',
  cls: (i,c) => document.getElementById(i).className = c,
  text: (i,t) => document.getElementById(i).textContent = t,
  enable: i => document.getElementById(i).disabled = false,
  disable: i => document.getElementById(i).disabled = true
};

class TutorialModel {
  constructor() { this.reset(); }
  reset() {
    this.initialState = null;
    this.snapshots = [];
    this.annotations = [];
    this.pauses = [];
    this.globalStyles = "";
    this.duration = 0;
  }
  addSnapshot(timestamp, event, state) {
    this.snapshots.push({ timestamp, event, state });
    this.duration = Math.max(this.duration, timestamp);
  }
  toJSON() { return JSON.stringify({ ...this, version: "2.1" }, null, 2); }
  fromJSON(json) {
    const d = JSON.parse(json);
    Object.assign(this, d);
    // Restore missing defaults
    if(!this.pauses) this.pauses = [];
    if(!this.globalStyles) this.globalStyles = "";
  }
}

class TimelineRenderer {
  constructor() { this.scale = 50; /* px per sec */ }
  
  render(model) {
    const eventsTrack = Utils.id('eventsTrack');
    const noteTrack = Utils.id('annotationsTrack');
    const ruler = Utils.id('timelineRuler');
    const container = Utils.id('timelineContainer');
    const wrapper = Utils.id('timelineWrapper');
    
    container.classList.add('visible');
    eventsTrack.innerHTML = '';
    noteTrack.innerHTML = '';
    ruler.innerHTML = '';
    
    // Clear old pauses from wrapper
    wrapper.querySelectorAll('.timeline-pause').forEach(el => el.remove());

    // Calculate dimensions
    const durationSec = Math.max(model.duration / 1000, 10); // Min 10s visual
    const width = durationSec * this.scale + 100; // Padding
    wrapper.style.width = width + 'px';
    
    // Ruler
    for (let t = 0; t <= durationSec; t += (durationSec > 60 ? 5 : 1)) {
      const tick = document.createElement('div');
      tick.className = 'timeline-tick';
      tick.style.left = (t * this.scale) + 'px';
      tick.textContent = t + 's';
      ruler.appendChild(tick);
    }

    // Events - Group Drag Logic
    let i = 0;
    while (i < model.snapshots.length) {
      const startSnap = model.snapshots[i];
      const action = startSnap.event.action;
      
      // Detect Drag Sequence
      if (action.endsWith('Start')) {
        const baseName = action.replace('Start', '');
        const endAction = baseName + 'End';
        let endIdx = i;
        
        // Find end
        for (let j = i + 1; j < model.snapshots.length; j++) {
          if (model.snapshots[j].event.action === endAction) {
            endIdx = j;
            break;
          }
        }
        
        const endSnap = model.snapshots[endIdx];
        const startX = (startSnap.timestamp / 1000) * this.scale;
        const width = Math.max(8, ((endSnap.timestamp - startSnap.timestamp) / 1000) * this.scale);
        
        const el = document.createElement('div');
        el.className = 'timeline-event drag-event';
        el.style.left = startX + 'px';
        el.style.width = width + 'px';
        el.title = baseName;
        eventsTrack.appendChild(el);
        
        i = endIdx + 1; // Skip grouped events
      } else {
        // Single Event
        if (!action.includes('drag') && !action.includes('Drag')) {
          const el = document.createElement('div');
          el.className = 'timeline-event';
          el.style.left = ((startSnap.timestamp / 1000) * this.scale) + 'px';
          el.title = action;
          eventsTrack.appendChild(el);
        }
        i++;
      }
    }

    // Annotations
    model.annotations.forEach((ann, idx) => {
      const el = document.createElement('div');
      el.className = 'timeline-annotation';
      el.style.left = ((ann.timestamp / 1000) * this.scale) + 'px';
      el.style.width = ((ann.duration / 1000) * this.scale) + 'px';
      const tmp = document.createElement('div'); tmp.innerHTML = ann.content;
      el.textContent = tmp.textContent || 'Note';
      noteTrack.appendChild(el);
    });

    // Pauses
    model.pauses.forEach(p => {
      const el = document.createElement('div');
      el.className = 'timeline-pause';
      el.style.left = ((p.timestamp / 1000) * this.scale) + 'px';
      wrapper.appendChild(el);
    });
  }
  
  updatePlayhead(timeMs) {
    const ph = Utils.id('timelinePlayhead');
    ph.style.display = 'block';
    ph.style.left = ((timeMs / 1000) * this.scale) + 'px';
  }
}

class AppController {
  constructor() {
    this.model = new TutorialModel();
    this.timeline = new TimelineRenderer();
    this.iframe = Utils.id('appFrame');
    this.api = null;
    this.state = 'idle'; // idle, recording, paused, playing
    this.startTime = 0;
    this.pauseTime = 0;
    this.timerId = null;
    
    this.initUI();
  }

  async initUI() {
    // Load
    Utils.id('loadApp').onclick = async () => {
      const url = Utils.id('appUrl').value || 'confidence-demo-new-13.html';
      this.iframe.src = url;
      this.iframe.onload = () => this.waitForApi();
    };

    // Record
    Utils.id('startRecording').onclick = () => this.startRecord();
    Utils.id('pauseRecording').onclick = () => this.pauseRecord();
    Utils.id('resumeRecording').onclick = () => this.resumeRecord();
    
    // Tools
    Utils.id('addAnnotation').onclick = () => this.openAnnModal();
    Utils.id('addPause').onclick = () => {
      this.model.pauses.push({ timestamp: this.model.duration });
      this.timeline.render(this.model);
    };
    
    // Preview
    Utils.id('preview').onclick = () => this.togglePreview();
    
    // Import/Export
    Utils.id('exportBtn').onclick = () => {
      Utils.id('exportTextarea').value = this.model.toJSON();
      Utils.id('exportModal').classList.add('visible');
    };
    Utils.id('closeExport').onclick = () => Utils.id('exportModal').classList.remove('visible');
    
    Utils.id('importBtn').onclick = () => Utils.id('fileInput').click();
    Utils.id('fileInput').onchange = (e) => this.importFile(e);
    
    // Modal logic
    Utils.id('annNext').onclick = () => this.setupAnnPositioning();
    Utils.id('posSave').onclick = () => this.saveAnnotation();
    Utils.id('posDelete').onclick = () => {
      Utils.hide('posOverlay');
      this.getBridgeAnnBox().style.display = 'none';
    };
    
    // Styles
    Utils.id('stylesBtn').onclick = () => {
      Utils.id('globalStylesContent').value = this.model.globalStyles || ".simple-box { background: white; border: 2px solid blue; padding: 10px; border-radius: 5px; }";
      Utils.id('stylesModal').classList.add('visible');
    };
    Utils.id('stylesSave').onclick = () => {
      this.model.globalStyles = Utils.id('globalStylesContent').value;
      this.injectGlobalStyles(this.model.globalStyles);
      Utils.id('stylesModal').classList.remove('visible');
    };
    Utils.id('stylesCancel').onclick
